package com.massivecraft.factions.listeners;

import com.massivecraft.factions.Conf;
import org.bukkit.Location;
import org.bukkit.Material;
import org.bukkit.block.Block;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.block.BlockFromToEvent;
import org.bukkit.event.player.PlayerTeleportEvent;
import org.bukkit.event.player.PlayerTeleportEvent.TeleportCause;

public class FactionsExploitListener implements Listener {
   @EventHandler(
      priority = EventPriority.NORMAL
   )
   public void obsidianGenerator(BlockFromToEvent event) {
      if (!event.isCancelled() && Conf.handleExploitObsidianGenerators) {
         Material source = event.getBlock().getType();
         Block block = event.getToBlock();
         if ((source == Material.AIR || source == Material.LAVA) && block.getType() == Material.REDSTONE_WIRE) {
            block.setType(Material.AIR);
         }
      }
   }

   @EventHandler(
      priority = EventPriority.NORMAL
   )
   public void enderPearlTeleport(PlayerTeleportEvent event) {
      if (!event.isCancelled() && Conf.handleExploitEnderPearlClipping) {
         if (event.getCause() == TeleportCause.ENDER_PEARL) {
            Location target = event.getTo();
            Location from = event.getFrom();
            Material mat = event.getTo().getBlock().getType();
            if ((mat != Material.GLASS_PANE && mat != Material.IRON_BARS || !clippingThrough(target, from, 0.65))
               && (mat != Material.OAK_FENCE && mat != Material.NETHER_BRICK_FENCE || !clippingThrough(target, from, 0.45))) {
               target.setX(target.getBlockX() + 0.5);
               target.setZ(target.getBlockZ() + 0.5);
               event.setTo(target);
            } else {
               event.setTo(from);
            }
         }
      }
   }

   public static boolean clippingThrough(Location target, Location from, double thickness) {
      return from.getX() > target.getX() && from.getX() - target.getX() < thickness
         || target.getX() > from.getX() && target.getX() - from.getX() < thickness
         || from.getZ() > target.getZ() && from.getZ() - target.getZ() < thickness
         || target.getZ() > from.getZ() && target.getZ() - from.getZ() < thickness;
   }
}
